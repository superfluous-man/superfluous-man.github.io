L.Control.Elevation=L.Control.extend({includes:L.Evented?L.Evented.prototype:L.Mixin.Events,options:{autohide:!0,autohideMarker:!0,collapsed:!1,controlButton:{iconCssClass:"elevation-toggle-icon",title:"Elevation"},detached:!0,distanceFactor:1,downloadLink:"link",elevationDiv:"#elevation-div",followMarker:!0,forceAxisBounds:!1,gpxOptions:{async:!0,marker_options:{startIconUrl:null,endIconUrl:null,shadowUrl:null,wptIcons:{"":L.divIcon({className:"elevation-waypoint-marker",html:'<i class="elevation-waypoint-icon"></i>',iconSize:[30,30],iconAnchor:[8,30]})}},polyline_options:{className:"",color:"#566B13",opacity:.75,weight:5,lineCap:"round"}},height:200,heightFactor:1,hoverNumber:{decimalsX:2,decimalsY:0,formatter:void 0},imperial:!1,interpolation:"curveLinear",lazyLoadJS:!0,legend:!0,loadData:{defer:!1,lazy:!1},marker:"elevation-line",markerIcon:L.divIcon({className:"elevation-position-marker",html:'<i class="elevation-position-icon"></i>',iconSize:[32,32],iconAnchor:[16,16]}),placeholder:!1,position:"topright",reverseCoords:!1,skipNullZCoords:!1,theme:"lightblue-theme",margins:{top:10,right:20,bottom:30,left:50},responsive:!0,summary:"inline",width:600,xLabel:"km",xTicks:void 0,yAxisMax:void 0,yAxisMin:void 0,yLabel:"m",yTicks:void 0,zFollow:13},__mileFactor:.621371,__footFactor:3.28084,addData:function(e,t){this._addData(e),this._container&&this._applyData(),(typeof t=="undefined"||t===null)&&e.on&&(t=e),t&&(t._path&&L.DomUtil.addClass(t._path,"elevation-polyline "+this.options.theme),t.on("mousemove",this._mousemoveLayerHandler,this).on("mouseout",this._mouseoutHandler,this)),this.track_info=this.track_info||{},this.track_info.distance=this._distance,this.track_info.elevation_max=this._maxElevation,this.track_info.elevation_min=this._minElevation,this._layers=this._layers||{},this._layers[L.Util.stamp(t)]=t;var n={data:e,layer:t,track_info:this.track_info};this.fire&&this.fire("eledata_added",n,!0),this._map&&this._map.fire("eledata_added",n,!0)},addTo:function(e){return this.options.detached?this._addToChartDiv(e):L.Control.prototype.addTo.call(this,e),this},clear:function(){this._clearPath(),this._clearChart(),this._clearData(),this.fire&&this.fire("eledata_clear"),this._map&&this._map.fire("eledata_clear")},disableDragging:function(){this._draggingEnabled=!1,this._resetDrag()},enableDragging:function(){this._draggingEnabled=!0},fitBounds:function(e){e=e||this._fullExtent,this._map&&e&&this._map.fitBounds(e)},getZFollow:function(){return this._zFollow},hide:function(){this._container.style.display="none"},initialize:function(e){this.options.autohide=typeof e.autohide!="undefined"?e.autohide:!L.Browser.mobile,typeof e.detachedView!="undefined"&&(this.options.detached=e.detachedView),typeof e.responsiveView!="undefined"&&(this.options.responsive=e.responsiveView),typeof e.showTrackInfo!="undefined"&&(this.options.summary=e.showTrackInfo),typeof e.summaryType!="undefined"&&(this.options.summary=e.summaryType),typeof e.autohidePositionMarker!="undefined"&&(this.options.autohideMarker=e.autohidePositionMarker),typeof e.followPositionMarker!="undefined"&&(this.options.followMarker=e.followPositionMarker),typeof e.useLeafletMarker!="undefined"&&(this.options.marker=e.useLeafletMarker?"position-marker":"elevation-line"),typeof e.leafletMarkerIcon!="undefined"&&(this.options.markerIcon=e.leafletMarkerIcon),typeof e.download!="undefined"&&(this.options.downloadLink=e.download),this.options=this._deepMerge({},this.options,e),this._draggingEnabled=!L.Browser.mobile,this._chartEnabled=!0,e.imperial?(this._distanceFactor=this.__mileFactor,this._heightFactor=this.__footFactor,this._xLabel="mi",this._yLabel="ft"):(this._distanceFactor=this.options.distanceFactor,this._heightFactor=this.options.heightFactor,this._xLabel=this.options.xLabel,this._yLabel=this.options.yLabel),this._zFollow=this.options.zFollow,this.options.followMarker&&(this._setMapView=L.Util.throttle(this._setMapView,300,this)),this.options.placeholder&&(this.options.loadData.lazy=this.options.loadData.defer=!0)},load:function(e,t){this.loadData(e,t)},loadChart:function(e){this.addTo(e)},loadData:function(e,t){t=L.extend({},this.options.loadData,t),t.defer?this.loadDefer(e,t):t.lazy?this.loadLazy(e,t):this._isXMLDoc(e)?this.loadGPX(e):this._isJSONDoc(e)?this.loadGeoJSON(e):this.loadFile(e)},loadDefer:function(e,t){t=L.extend({},this.options.loadData,t),t.defer=!1,document.readyState!=="complete"?window.addEventListener("load",L.bind(this.loadData,this,e,t),{once:!0}):this.loadData(e,t)},loadFile:function(e){this._downloadURL=e;try{var t=new XMLHttpRequest;t.responseType="text",t.open("GET",e),t.onload=function(){if(t.status!==200)throw"Error "+t.status+" while fetching remote file: "+e;this.loadData(t.response,{lazy:!1,defer:!1})}.bind(this),t.send()}catch(e){console.warn(e)}},loadGeoJSON:function(e){typeof e=="string"&&(e=JSON.parse(e)),this.layer=this.geojson=L.geoJson(e,{style:function(){return{color:"#566B13",className:"elevation-polyline "+this.options.theme}}.bind(this),onEachFeature:function(t,n){this.addData(t,n),this.track_info=this.track_info||{},this.track_info.type="geojson",this.track_info.name=e.name,this.track_info.distance=this._distance,this.track_info.elevation_max=this._maxElevation,this.track_info.elevation_min=this._minElevation}.bind(this)}),this._map?(this._map.once("layeradd",function(){this.fitBounds(this.layer.getBounds());var n={data:e,layer:this.layer,name:this.track_info.name,track_info:this.track_info};this.fire&&this.fire("eledata_loaded",n,!0),this._map&&this._map.fire("eledata_loaded",n,!0)},this),this.layer.addTo(this._map)):console.warn("Undefined elevation map object")},loadGPX:function(e){var t=function(e){this.options.gpxOptions.polyline_options.className+="elevation-polyline "+this.options.theme,this.layer=this.gpx=new L.GPX(e,this.options.gpxOptions),this.layer.on("loaded",function(e){this.fitBounds(e.target.getBounds())},this),this.layer.on("addpoint",function(e){(e.point_type==="start"||e.point_type==="end")&&e.point.setZIndexOffset(1e4),e.point._popup&&(e.point._popup.options.className="elevation-popup",e.point._popup._content=decodeURI(e.point._popup._content)),e.point._popup&&e.point._popup._content&&e.point.bindTooltip(e.point._popup._content,{direction:"top",sticky:!0,opacity:1,className:"elevation-tooltip"}).openTooltip()}),this.layer.once("addline",function(t){this.addData(t.line),this.track_info=this.track_info||{},this.track_info.type="gpx",this.track_info.name=this.layer.get_name(),this.track_info.distance=this._distance,this.track_info.elevation_max=this._maxElevation,this.track_info.elevation_min=this._minElevation;var n={data:e,layer:this.layer,name:this.track_info.name,track_info:this.track_info};this.fire&&this.fire("eledata_loaded",n,!0),this._map&&this._map.fire("eledata_loaded",n,!0)},this),this._map?this.layer.addTo(this._map):console.warn("Undefined elevation map object")}.bind(this,e);typeof L.GPX!="function"&&this.options.lazyLoadJS?(L.Control.Elevation._gpxLazyLoader=this._lazyLoadJS("https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.0/gpx.js",L.Control.Elevation._gpxLazyLoader),L.Control.Elevation._gpxLazyLoader.then(t)):t.call()},loadLazy:function(e,t){t=L.extend({},this.options.loadData,t),t.lazy=!1;let s=!1,n=L.bind(function(e){s||(L.Util.requestAnimFrame(function(){this._isVisible(this.placeholder)&&(window.removeEventListener("scroll",n),this.loadData(e,t),this.once("eledata_loaded",function(){this.placeholder&&this.placeholder.parentNode&&this.placeholder.parentNode.removeChild(this.placeholder)},this)),s=!1},this),s=!0)},this,e);window.addEventListener("scroll",n),this.placeholder&&this.placeholder.addEventListener("mouseenter",n,{once:!0}),n()},onAdd:function(e){this._map=e;var n,t=this._container=L.DomUtil.create("div","elevation-control elevation");if(this.options.detached||L.DomUtil.addClass(t,"leaflet-control"),this.options.theme&&L.DomUtil.addClass(t,this.options.theme),this.options.placeholder&&!this._data){if(this.placeholder=L.DomUtil.create("img","elevation-placeholder"),typeof this.options.placeholder=="string")this.placeholder.src=this.options.placeholder,this.placeholder.alt="";else for(let e in this.options.placeholder)this.placeholder.setAttribute(e,this.options.placeholder[e]);t.insertBefore(this.placeholder,t.firstChild)}return n=function(e,t){this._initToggle(t),this._initChart(t),this._applyData(),this._map.on("zoom viewreset zoomanim",this._hidePositionMarker,this),this._map.on("resize",this._resetView,this),this._map.on("resize",this._resizeChart,this),this._map.on("mousedown",this._resetDrag,this),this._map.on("eledata_loaded",this._updateSummary,this),L.DomEvent.on(this._map._container,"mousewheel",this._resetDrag,this),L.DomEvent.on(this._map._container,"touchstart",this._resetDrag,this)}.bind(this,e,t),typeof d3!="object"&&this.options.lazyLoadJS?(L.Control.Elevation._d3LazyLoader=this._lazyLoadJS("https://unpkg.com/d3@4.13.0/build/d3.min.js",L.Control.Elevation._d3LazyLoader),L.Control.Elevation._d3LazyLoader.then(n)):n.call(),t},onRemove:function(){this._container=null},redraw:function(){this._resizeChart()},setZFollow:function(e){this._zFollow=e},show:function(){this._container.style.display="block"},_addData:function(e){var t,s,n=e&&e.geometry&&e.geometry;if(n)switch(n.type){case"LineString":this._addGeoJSONData(n.coordinates);break;case"MultiLineString":for(t=0;t<n.coordinates.length;t++)this._addGeoJSONData(n.coordinates[t]);break;default:console.warn("Unsopperted GeoJSON feature geometry type:"+n.type)}if(s=e&&e.type==="FeatureCollection",s)for(t=0;t<e.features.length;t++)this._addData(e.features[t]);e&&e._latlngs&&this._addGPXdata(e._latlngs)},_addGeoJSONData:function(e){if(e)for(var t=0;t<e.length;t++)this._addPoint(e[t][1],e[t][0],e[t][2])},_addGPXdata:function(e){if(e)for(var t=0;t<e.length;t++)this._addPoint(e[t].lat,e[t].lng,e[t].meta.ele)},_addPoint:function(e,t,n){if(this.options.reverseCoords){var s,o,i,a,r,c,l,d,u,h,m=e;e=t,t=m}s=this._data||[],i=this._maxElevation||-(1/0),a=this._minElevation||+(1/0),r=this._distance||0,d=new L.LatLng(e,t),u=s.length?s[s.length-1].latlng:d,h=d.distanceTo(u)*this._distanceFactor,r=r+Math.round(h/1e3*1e5)/1e5,!this.options.skipNullZCoords&&s.length>0&&(o=s[s.length-1].z,isNaN(o)&&(c=this._lastValidZ,l=n*this._heightFactor,!isNaN(c)&&!isNaN(l)?o=(c+l)/2:isNaN(c)?isNaN(l)||(o=l):o=c,isNaN(o)?s.splice(s.length-1,1):s[s.length-1].z=o)),n=n*this._heightFactor,isNaN(n)||(i=i<n?n:i,a=a>n?n:a,this._lastValidZ=n),s.push({dist:r,x:e,y:t,z:n,latlng:d}),this._data=s,this._distance=r,this._maxElevation=i,this._minElevation=a},_addToChartDiv:function(e){this._appendElevationDiv(e._container).appendChild(this.onAdd(e))},_appendChart:function(e){var t=e.append("g").attr("transform","translate("+this.options.margins.left+","+this.options.margins.top+")");this._appendGrid(t),this._appendAreaPath(t),this._appendAxis(t),this._appendFocusRect(t),this._appendMouseFocusG(t),this._appendLegend(t)},_appendElevationDiv:function(e){var t=document.querySelector(this.options.elevationDiv);return t||(t=L.DomUtil.create("div","leaflet-control elevation elevation-div"),this.options.elevationDiv="#elevation-div_"+Math.random().toString(36).substr(2,9),t.id=this.options.elevationDiv.substr(1),e.parentNode.insertBefore(t,e.nextSibling)),this.options.detached&&(L.DomUtil.addClass(t,"elevation-detached"),L.DomUtil.removeClass(t,"leaflet-control")),this.eleDiv=t,this.eleDiv},_appendXaxis:function(e){e.append("g").attr("class","x axis").attr("transform","translate(0,"+this._height()+")").call(d3.axisBottom().scale(this._x).ticks(this.options.xTicks)).append("text").attr("x",this._width()+6).attr("y",30).text(this._xLabel)},_appendXGrid:function(e){e.append("g").attr("class","x grid").attr("transform","translate(0,"+this._height()+")").call(d3.axisBottom().scale(this._x).ticks(this.options.xTicks).tickSize(-this._height()).tickFormat(""))},_appendYaxis:function(e){e.append("g").attr("class","y axis").call(d3.axisLeft().scale(this._y).ticks(this.options.yTicks)).append("text").attr("x",-30).attr("y",-5).text(this._yLabel)},_appendYGrid:function(e){e.append("g").attr("class","y grid").call(d3.axisLeft().scale(this._y).ticks(this.options.yTicks).tickSize(-this._width()).tickFormat(""))},_appendAreaPath:function(e){this._areapath=e.append("path").attr("class","area")},_appendAxis:function(e){this._axis=e.append("g").attr("class","axis"),this._appendXaxis(this._axis),this._appendYaxis(this._axis)},_appendFocusRect:function(e){var t=this._focusRect=e.append("rect").attr("width",this._width()).attr("height",this._height()).style("fill","none").style("stroke","none").style("pointer-events","all");L.Browser.mobile&&(t.on("touchmove.drag",this._dragHandler.bind(this)).on("touchstart.drag",this._dragStartHandler.bind(this)).on("touchstart.focus",this._mousemoveHandler.bind(this)).on("touchmove.focus",this._mousemoveHandler.bind(this)),L.DomEvent.on(this._container,"touchend",this._dragEndHandler,this)),t.on("mousemove.drag",this._dragHandler.bind(this)).on("mousedown.drag",this._dragStartHandler.bind(this)).on("mouseenter.focus",this._mouseenterHandler.bind(this)).on("mousemove.focus",this._mousemoveHandler.bind(this)).on("mouseout.focus",this._mouseoutHandler.bind(this)),L.DomEvent.on(this._container,"mouseup",this._dragEndHandler,this)},_appendGrid:function(e){this._grid=e.append("g").attr("class","grid"),this._appendXGrid(this._grid),this._appendYGrid(this._grid)},_appendMouseFocusG:function(e){var t=this._focusG=e.append("g").attr("class","mouse-focus-group");this._mousefocus=t.append("svg:line").attr("class","mouse-focus-line").attr("x2","0").attr("y2","0").attr("x1","0").attr("y1","0"),this._focuslabelrect=t.append("rect").attr("class","mouse-focus-label").attr("x",0).attr("y",0).attr("width",0).attr("height",0).attr("rx",3).attr("ry",3),this._focuslabeltext=t.append("svg:text").attr("class","mouse-focus-label-text"),this._focuslabelY=this._focuslabeltext.append("svg:tspan").attr("class","mouse-focus-label-y").attr("dy","-1em"),this._focuslabelX=this._focuslabeltext.append("svg:tspan").attr("class","mouse-focus-label-x").attr("dy","2em")},_appendLegend:function(e){if(!this.options.legend)return;var n=this._legend=e.append("g").attr("class","legend"),t=this._altitudeLegend=this._legend.append("g").attr("class","legend-altitude");t.append("rect").attr("class","area").attr("x",this._width()/2-50).attr("y",this._height()+this.options.margins.bottom-17).attr("width",50).attr("height",5).attr("opacity",.75),t.append("text").text("Altitude").attr("x",this._width()/2+5).attr("font-size",10).style("text-decoration-thickness","2px").style("font-weight","700").attr("y",this._height()+this.options.margins.bottom-11)},_appendPositionMarker:function(e){var t=this.options.theme,n=e.select("g");this._mouseHeightFocus=n.append("svg:line").attr("class",t+" height-focus line").attr("x2",0).attr("y2",0).attr("x1",0).attr("y1",0),this._pointG=n.append("g"),this._pointG.append("svg:circle").attr("class",t+" height-focus circle-lower").attr("r",6).attr("cx",0).attr("cy",0),this._mouseHeightFocusLabel=n.append("svg:text").attr("class",t+" height-focus-label").style("pointer-events","none")},_applyData:function(){if(!this._data)return;var n=d3.extent(this._data,function(e){return e.dist}),t=d3.extent(this._data,function(e){return e.z}),e=this.options;e.yAxisMin!==void 0&&(e.yAxisMin<t[0]||e.forceAxisBounds)&&(t[0]=e.yAxisMin),e.yAxisMax!==void 0&&(e.yAxisMax>t[1]||e.forceAxisBounds)&&(t[1]=e.yAxisMax),this._x.domain(n),this._y.domain(t),this._areapath.datum(this._data).attr("d",this._area),this._updateAxis(),this._fullExtent=this._calculateFullExtent(this._data)},_calculateFullExtent:function(e){if(!e||e.length<1)throw new Error("no data in parameters");var t=new L.latLngBounds(e[0].latlng,e[0].latlng);return e.forEach(function(e){t.extend(e.latlng)}),t},_clearChart:function(){this._resetDrag(),this._areapath&&(this._areapath.attr("d","M0 0"),this._x.domain([0,1]),this._y.domain([0,1]),this._updateAxis()),this._altitudeLegend&&this._altitudeLegend.select("text").style("text-decoration-line","line-through")},_clearData:function(){this._data=null,this._distance=null,this._maxElevation=null,this._minElevation=null,this.track_info=null,this._layers=null},_clearPath:function(){this._hidePositionMarker();for(var e in this._layers)L.DomUtil.removeClass(this._layers[e]._path,"elevation-polyline"),L.DomUtil.removeClass(this._layers[e]._path,this.options.theme)},_collapse:function(){this._container&&(L.DomUtil.removeClass(this._container,"elevation-expanded"),L.DomUtil.addClass(this._container,"elevation-collapsed"))},_deepMerge:function(e,...n){if(!n.length)return e;const t=n.shift();if(this._isObject(e)&&this._isObject(t))for(const n in t)this._isObject(t[n])?(e[n]||Object.assign(e,{[n]:{}}),this._deepMerge(e[n],t[n])):Object.assign(e,{[n]:t[n]});return this._deepMerge(e,...n)},_saveFile:function(e){var n=document,t=n.createElement("a"),s=n.body;t.href=e,t.target="_new",t.download="",t.style.display="none",s.appendChild(t),t.click(),s.removeChild(t)},_dragHandler:function(){d3.event.preventDefault(),d3.event.stopPropagation(),this._gotDragged=!0,this._drawDragRectangle()},_dragEndHandler:function(){if(!this._dragStartCoords||!this._dragCurrentCoords||!this._gotDragged){this._dragStartCoords=null,this._gotDragged=!1,this._draggingEnabled&&this._resetDrag();return}var n,e=this._findItemForX(this._dragStartCoords[0]),t=this._findItemForX(this._dragCurrentCoords[0]);if(e==t)return;this._hidePositionMarker(),this._fitSection(e,t),this._dragStartCoords=null,this._gotDragged=!1,n={data:{dragstart:this._data[e],dragend:this._data[t]}},this.fire&&this.fire("elechart_dragged",n,!0),this._map&&this._map.fire("elechart_dragged",n,!0)},_dragStartHandler:function(){d3.event.preventDefault(),d3.event.stopPropagation(),this._gotDragged=!1,this._dragStartCoords=d3.mouse(this._focusRect.node())},_drawDragRectangle:function(){if(!this._dragStartCoords||!this._draggingEnabled)return;var s,t=this._dragCurrentCoords=d3.mouse(this._focusRect.node()),e=Math.min(this._dragStartCoords[0],t[0]),n=Math.max(this._dragStartCoords[0],t[0]);!this._dragRectangle&&!this._dragRectangleG?(s=d3.select(this._container).select("svg").select("g"),this._dragRectangleG=s.insert("g",".mouse-focus-group"),this._dragRectangle=this._dragRectangleG.append("rect").attr("width",n-e).attr("height",this._height()).attr("x",e).attr("class","mouse-drag").style("pointer-events","none")):this._dragRectangle.attr("width",n-e).attr("x",e)},_expand:function(){this._container&&(L.DomUtil.removeClass(this._container,"elevation-collapsed"),L.DomUtil.addClass(this._container,"elevation-expanded"))},_findItemForLatLng:function(e){var t=null,n=1/0;return this._data.forEach(function(s){var o=e.distanceTo(s.latlng);o<n&&(n=o,t=s)}),t},_findItemForX:function(e){var t=d3.bisector(function(e){return e.dist}).left,n=this._x.invert(e);return t(this._data,n)},_fitSection:function(e,t){var n=Math.min(e,t),s=Math.max(e,t),o=this._calculateFullExtent(this._data.slice(n,s));this.fitBounds(o)},_formatter:function(e,t,n){t===0?s=Math.round(e)+"":s=L.Util.formatNum(e,t)+"";var s,i,o=s.split(".");if(o[1]){for(i=t-o[1].length;i>0;i--)o[1]+="0";s=o.join(n||".")}return s},_height:function(){var e=this.options;return e.height-e.margins.top-e.margins.bottom},_hidePositionMarker:function(){if(!this.options.autohideMarker)return;this._selectedItem=null,this._marker&&(this._map&&this._map.removeLayer(this._marker),this._marker=null),this._mouseHeightFocus&&(this._mouseHeightFocus.style("visibility","hidden"),this._mouseHeightFocusLabel.style("visibility","hidden")),this._pointG&&this._pointG.style("visibility","hidden"),this._focusG&&this._focusG.style("visibility","hidden")},_initChart:function(){var t,n,s,o,i,a,r,c,l,d,u,e=this.options;e.xTicks=e.xTicks||Math.round(this._width()/75),e.yTicks=e.yTicks||Math.round(this._height()/30),e.hoverNumber.formatter=e.hoverNumber.formatter||this._formatter,e.responsive&&(e.detached?(t=this.eleDiv.offsetWidth,n=this.eleDiv.offsetHeight,e.width=t>0?t:e.width,e.height=n-20>0?n-20:e.height):(e._maxWidth=e._maxWidth>e.width?e._maxWidth:e.width,s=this._map._container.clientWidth,e.width=e._maxWidth>s?s-30:e.width)),a=this._x=d3.scaleLinear().range([0,this._width()]),r=this._y=d3.scaleLinear().range([this._height(),0]),c=typeof e.interpolation=="function"?e.interpolation:d3[e.interpolation],l=this._area=d3.area().curve(c).x(function(e){return e.xDiagCoord=a(e.dist)}).y0(this._height()).y1(function(e){return r(e.z)}),d=this._line=d3.line().x(function(){return d3.mouse(i.select("g"))[0]}).y(function(){return this._height()}),o=d3.select(this._container),i=o.append("svg").attr("class","background").attr("width",e.width).attr("height",e.height),u=this.summaryDiv=o.append("div").attr("class","elevation-summary "+this.options.summary+"-summary").node(),this._appendChart(i),this._updateSummary()},_initToggle:function(e){if(e.setAttribute("aria-haspopup",!0),this.options.detached||L.DomEvent.disableClickPropagation(e),L.Browser.mobile&&L.DomEvent.on(e,"click",L.DomEvent.stopPropagation),!this.options.detached){var n="elevation-toggle "+this.options.controlButton.iconCssClass+(this.options.autohide?"":" close-button"),t=this._button=L.DomUtil.create("a",n,e);t.href="#",t.title=this.options.controlButton.title,this.options.collapsed&&(this._collapse(),this.options.autohide?L.DomEvent.on(e,"mouseover",this._expand,this).on(e,"mouseout",this._collapse,this):L.DomEvent.on(t,"click",L.DomEvent.stop).on(t,"click",this._toggle,this),L.DomEvent.on(t,"focus",this._toggle,this),this._map.on("click",this._collapse,this))}},_isObject:function(e){return e&&typeof e=="object"&&!Array.isArray(e)},_isJSONDoc:function(e,t){if(t=typeof t=="undefined"||t,typeof e=="string"&&t)return e=e.trim(),e.indexOf("{")==0||e.indexOf("[")==0;try{JSON.parse(e.toString())}catch(n){return!!(typeof e=="object"&&t)||(console.warn(n),!1)}return!0},_isXMLDoc:function(e,t){if(t=typeof t=="undefined"||t,typeof e=="string"&&t)return e=e.trim(),e.indexOf("<")==0;var n=(e?e.ownerDocument||e:0).documentElement;return!!n&&n.nodeName!=="HTML"},_isDomVisible:function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},_isVisible:function(e){if(!e)return!1;let t=window.getComputedStyle(e);function n(e,t){return t.visibility!=="hidden"&&t.display!=="none"}function s(e,t){let n=e.getBoundingClientRect(),i=n.left+1,a=n.right-1,o=n.top+1,c=n.bottom-1,s=!0,r=e.style.pointerEvents;return t["pointer-events"]=="none"&&(e.style.pointerEvents="auto"),document.elementFromPoint(i,o)!==e&&(s=!1),document.elementFromPoint(a,o)!==e&&(s=!1),e.style.pointerEvents=r,s}return!!n(e,t)&&!!s(e,t)},_lazyLoadJS:function(e,t){return typeof t=="undefined"&&(t=!1),t instanceof Promise?t:new Promise(function(n){if(t)return n();var o=document.createElement("script");o.addEventListener("load",n,{once:!0}),o.src=e,document.head.appendChild(o)})},_mouseenterHandler:function(){this.fire&&this.fire("elechart_enter",null,!0),this._map&&this._map.fire("elechart_enter",null,!0)},_mousemoveHandler:function(){if(!this._data||this._data.length===0||!this._chartEnabled)return;var s,a=d3.mouse(this._focusRect.node()),i=a[0],o=this._data[this._findItemForX(i)];this._hidePositionMarker(),this._showDiagramIndicator(o,i),this._showPositionMarker(o),this._setMapView(o),this._map&&this._map._container&&L.DomUtil.addClass(this._map._container,"elechart-hover"),s={data:o},this.fire&&(this.fire("elechart_change",s,!0),this.fire("elechart_hover",s,!0)),this._map&&(this._map.fire("elechart_change",s,!0),this._map.fire("elechart_hover",s,!0))},_mousemoveLayerHandler:function(e){if(!this._data||this._data.length===0)return;var n,s=e.latlng,t=this._findItemForLatLng(s);t&&(n=t.xDiagCoord,this._hidePositionMarker(),this._showDiagramIndicator(t,n),this._showPositionMarker(t))},_mouseoutHandler:function(){this.options.detached||this._hidePositionMarker(),this._map&&this._map._container&&L.DomUtil.removeClass(this._map._container,"elechart-hover"),this.fire&&this.fire("elechart_leave",null,!0),this._map&&this._map.fire("elechart_leave",null,!0)},_mousewheelHandler:function(e){if(this._map.gestureHandling&&this._map.gestureHandling._enabled)return;var t=this._selectedItem?this._selectedItem.latlng:this._map.getCenter(),n=e.deltaY>0?this._map.getZoom()-1:this._map.getZoom()+1;this._resetDrag(),this._map.flyTo(t,n)},_resetDrag:function(){this._dragRectangleG&&(this._dragRectangleG.remove(),this._dragRectangleG=null,this._dragRectangle=null,this._hidePositionMarker())},_resetView:function(){if(this._map&&this._map._isFullscreen)return;this._resetDrag(),this._hidePositionMarker(),this.fitBounds(this._fullExtent)},_resizeChart:function(){if(this.options.responsive)if(this.options.detached){var e=this.eleDiv.offsetWidth;if(e<=0)return;this.options.width=e,this.eleDiv.innerHTML="",this.eleDiv.appendChild(this.onAdd(this._map))}else this._map.removeControl(this._container),this.addTo(this._map)},_showDiagramIndicator:function(e,t){if(!this._chartEnabled)return;s=this.options,this._focusG.style("visibility","visible"),this._mousefocus.attr("x1",t).attr("y1",0).attr("x2",t).attr("y2",this._height()).classed("hidden",!1);var n,s,o,i,a=e.z,r=e.dist,d=e.latlng,c=s.hoverNumber.formatter(a,s.hoverNumber.decimalsY),l=s.hoverNumber.formatter(r,s.hoverNumber.decimalsX);this._focuslabeltext.attr("y",this._y(e.z)).style("font-weight","700"),this._focuslabelX.text(l+" "+this._xLabel).attr("x",t+10),this._focuslabelY.text(c+" "+this._yLabel).attr("x",t+10),i=this._focuslabeltext.node(),this._isDomVisible(i)&&(o=i.getBBox(),n=2,this._focuslabelrect.attr("x",o.x-n).attr("y",o.y-n).attr("width",o.width+n*2).attr("height",o.height+n*2),t>=this._width()/2&&(this._focuslabelrect.attr("x",this._focuslabelrect.attr("x")-this._focuslabelrect.attr("width")-n*2-10),this._focuslabelX.attr("x",this._focuslabelX.attr("x")-this._focuslabelrect.attr("width")-n*2-10),this._focuslabelY.attr("x",this._focuslabelY.attr("x")-this._focuslabelrect.attr("width")-n*2-10)))},_toggle:function(){L.DomUtil.hasClass(this._container,"elevation-expanded")?this._collapse():this._expand()},_setMapView:function(e){if(!this.options.followMarker||!this._map)return;var t=this._map.getZoom(),t=t<this._zFollow?this._zFollow:t;this._map.setView(e.latlng,t,{animate:!0,duration:.25})},_showPositionMarker:function(e){this._selectedItem=e,this._map&&!this._map.getPane("elevationPane")&&(this._map.createPane("elevationPane"),this._map.getPane("elevationPane").style.zIndex=625,this._map.getPane("elevationPane").style.pointerEvents="none"),this.options.marker=="elevation-line"?this._updatePositionMarker(e):this.options.marker=="position-marker"&&this._updateLeafletMarker(e)},_updateAxis:function(){this._grid.selectAll("g").remove(),this._axis.selectAll("g").remove(),this._appendXGrid(this._grid),this._appendYGrid(this._grid),this._appendXaxis(this._axis),this._appendYaxis(this._axis)},_updateHeightIndicator:function(e){var t=this.options,s=t.hoverNumber.formatter(e.z,t.hoverNumber.decimalsY),i=t.hoverNumber.formatter(e.dist,t.hoverNumber.decimalsX),o=this._height()/this._maxElevation*e.z,n=e.y-o;this._mouseHeightFocus.attr("x1",e.x).attr("x2",e.x).attr("y1",e.y).attr("y2",n).style("visibility","visible"),this._mouseHeightFocusLabel.attr("x",e.x).attr("y",n).text(s+" "+this._yLabel).style("visibility","visible")},_updateLeafletMarker:function(e){var t=e.latlng;this._marker?this._marker.setLatLng(t):(this._marker=new L.Marker(t,{icon:this.options.markerIcon,zIndexOffset:1e6}),this._marker.addTo(this._map,{pane:"elevationPane"}))},_updatePointG:function(e){this._pointG.attr("transform","translate("+e.x+","+e.y+")").style("visibility","visible")},_updatePositionMarker:function(e){var s,t=this._map.latLngToLayerPoint(e.latlng),n={dist:e.dist,x:t.x,y:t.y,z:e.z};this._mouseHeightFocus||(L.svg({pane:"elevationPane"}).addTo(this._map),s=d3.select(this._map.getContainer()).select(".leaflet-elevation-pane svg"),this._appendPositionMarker(s)),this._updatePointG(n),this._updateHeightIndicator(n)},_updateSummary:function(){if(this.options.summary&&this.summaryDiv&&(this.track_info=this.track_info||{},this.track_info.distance=this._distance||0,this.track_info.elevation_max=this._maxElevation||0,this.track_info.elevation_min=this._minElevation||0,d3.select(this.summaryDiv).html('<span class="totlen"><span class="summarylabel">Total Length: </span><span class="summaryvalue">'+this.track_info.distance.toFixed(2)+" "+this._xLabel+'</span></span><span class="maxele"><span class="summarylabel">Max Elevation: </span><span class="summaryvalue">'+this.track_info.elevation_max.toFixed(2)+" "+this._yLabel+'</span></span><span class="minele"><span class="summarylabel">Min Elevation: </span><span class="summaryvalue">'+this.track_info.elevation_min.toFixed(2)+" "+this._yLabel+"</span></span>")),this.options.downloadLink&&this._downloadURL){var e,t=document.createElement("span");t.className="download",e=document.createElement("a"),e.innerHTML="Download",e.href="#",e.onclick=function(e){e.preventDefault();var t={confirm:this._saveFile.bind(this,this._downloadURL)},n=this.options.downloadLink;n=="modal"?(typeof CustomEvent=="function"&&document.dispatchEvent(new CustomEvent("eletrack_download",{detail:t})),this.fire&&this.fire("eletrack_download",t),this._map&&this._map.fire("eletrack_download",t)):(n=="link"||n===!0)&&t.confirm()}.bind(this),this.summaryDiv.appendChild(t).appendChild(e)}},_width:function(){var e=this.options;return e.width-e.margins.left-e.margins.right}}),L.control.elevation=function(e){return new L.Control.Elevation(e)}